import{downloadQuestionsAsText,downloadBonusesAsCSV,downloadTossupsAsCSV,downloadQuestionsAsJSON}from"./download.js";import api from"../scripts/api/index.js";import star from"../scripts/auth/star.js";import TossupCard from"../scripts/components/TossupCard.min.js";import BonusCard from"../scripts/components/BonusCard.min.js";import CategoryModal from"../scripts/components/CategoryModal.min.js";import DifficultyDropdown from"../scripts/components/DifficultyDropdown.min.js";import Star from"../scripts/components/Star.min.js";import CategoryManager from"../../quizbowl/category-manager.js";import{getDropdownValues}from"../scripts/utilities/dropdown-checklist.js";import insertTokensIntoHTML from"../../quizbowl/insert-tokens-into-html.js";const starredTossupIds=new Set(await star.getStarredTossupIds()),starredBonusIds=new Set(await star.getStarredBonusIds()),paginationShiftLength=992<window.screen.width?10:5,categoryManager=new CategoryManager;function getMatchIndices(a,b){const c=a.matchAll(b),d=[],e=[];for(let f=c.next();!1===f.done;)d.push(f.value.index),e.push(f.value.index+f.value[0].length),f=c.next();return{starts:d,ends:e}}function highlightTossupQuery({tossup:a,regExp:b,searchType:e="all",ignoreWordOrder:c,queryString:d}){const f=c?d.split(" ").filter(a=>""!==a).map(a=>new RegExp(a,"ig")):[b];for(const g of f){if("question"===e||"all"===e){const{starts:b,ends:c}=getMatchIndices(a.question_sanitized,g);a.question=insertTokensIntoHTML(a.question,a.question_sanitized,[b,c])}if("answer"===e||"all"===e){const{starts:b,ends:c}=getMatchIndices(a.answer_sanitized,g);a.answer=insertTokensIntoHTML(a.answer,a.answer_sanitized,[b,c])}}return a}function highlightBonusQuery({bonus:a,regExp:b,searchType:e="all",ignoreWordOrder:c,queryString:d}){const f=c?d.split(" ").filter(a=>""!==a).map(a=>new RegExp(a,"ig")):[b];for(const g of f){if("question"===e||"all"===e){{const{starts:b,ends:c}=getMatchIndices(a.leadin_sanitized,g);a.leadin=insertTokensIntoHTML(a.leadin,a.leadin_sanitized,[b,c])}for(let b=0;b<a.parts.length;b++){const{starts:c,ends:d}=getMatchIndices(a.parts_sanitized[b],g);a.parts[b]=insertTokensIntoHTML(a.parts[b],a.parts_sanitized[b],[c,d])}}if("answer"===e||"all"===e)for(let b=0;b<a.answers.length;b++){const{starts:c,ends:d}=getMatchIndices(a.answers_sanitized[b],g);a.answers[b]=insertTokensIntoHTML(a.answers[b],a.answers_sanitized[b],[c,d])}}return a}function QueryForm(){function a(a,b){return Array(b-a).fill().map((b,c)=>a+c)}function b(){return Math.floor(1e4/(r||25))}function c(a,c){switch(a.preventDefault(),c){case"first":T=1;break;case"previous":T=Math.max(1,T-1);break;case"next":T=Math.min(X,T+1,b());break;case"last":T=Math.min(X,b());break;default:T=c}U(T),aa(paginationShiftLength*Math.floor((T-1)/paginationShiftLength)),e(a,!1,!0),window.scrollTo({top:document.getElementById("tossups").offsetTop-100,behavior:"smooth"})}function d(a,c){switch(a.preventDefault(),c){case"first":V=1;break;case"previous":V=Math.max(1,V-1);break;case"next":V=Math.min(Z,V+1,b());break;case"last":V=Math.min(Z,b());break;default:V=c}W(V),ca(paginationShiftLength*Math.floor((V-1)/paginationShiftLength)),e(a,!1,!0),window.scrollTo({top:document.getElementById("bonuses").offsetTop-100,behavior:"smooth"})}function e(a,b=!1,c=!1){const d=performance.now();a.preventDefault(),S(!0),(b||!c)&&(T=1,V=1,U(T),W(V));const e={queryString:t,...categoryManager.export(),difficulties:getDropdownValues("difficulties"),maxReturnLength:r,questionType:v,randomize:b,exactPhrase:H,caseSensitive:J,powermarkOnly:L,regex:D,ignoreWordOrder:F,searchType:x,setName:document.getElementById("set-name").value,tossupPagination:1===T?"":T,bonusPagination:1===V?"":V,minYear:z,maxYear:B};delete e.categoryPercents;const f=Object.fromEntries(Object.entries(e).filter(([a,b])=>""!==b&&null!==b&&void 0!==b&&!1!==b&&!(Array.isArray(b)&&0===b.length)&&("questionType"!==a||"all"!==b)&&("searchType"!==a||"all"!==b))),h=new URLSearchParams(f);fetch(`/api/query?${h}`).then(a=>{if(400===a.status)throw new Error("Invalid query");return a}).then(a=>a.json()).then(a=>{const{tossups:c,bonuses:e,queryString:f}=a,j=RegExp(f,J?"g":"ig"),l=Math.max(1,r||25),{count:n,questionArray:p}=c,{count:s,questionArray:u}=e,v=JSON.parse(JSON.stringify(p)),w=JSON.parse(JSON.stringify(u));// create deep copy to highlight
if(""!==t){for(let a=0;a<v.length;a++)v[a]=highlightTossupQuery({tossup:v[a],regExp:j,searchType:x,ignoreWordOrder:F,queryString:t});for(let a=0;a<w.length;a++)w[a]=highlightBonusQuery({bonus:w[a],regExp:j,searchType:x,ignoreWordOrder:F,queryString:t})}o(n),g(p),k(v),q(s),i(u),m(w),b?(Y(1),$(1)):(Y(Math.ceil(n/l)),$(Math.ceil(s/l))),aa(paginationShiftLength*Math.floor((T-1)/paginationShiftLength)),ca(paginationShiftLength*Math.floor((V-1)/paginationShiftLength));const y=performance.now(),z=((y-d)/1e3).toFixed(2);ea(z),window.history.pushState({tossups:c,highlightedTossupArray:v,bonuses:e,highlightedBonusArray:w,timeElapsed:z,workingMaxReturnLength:l,randomize:b},"","?"+h)}).catch(a=>{console.error("Error:",a),window.alert("Invalid query. Please check your search parameters and try again.")}).finally(()=>{document.querySelectorAll("b.collapsed[data-bs-toggle=\"collapse\"]").forEach(a=>a.classList.remove("collapsed")),document.querySelectorAll("div.card-container.collapse:not(.show)").forEach(a=>a.classList.add("show")),S(!1)})}const[f,g]=React.useState([]),[h,i]=React.useState([]),[j,k]=React.useState([]),[l,m]=React.useState([]),[n,o]=React.useState(0),[p,q]=React.useState(0),[r,s]=React.useState(""),[t,u]=React.useState(""),[v,w]=React.useState("all"),[x,y]=React.useState("all"),[z,A]=React.useState(""),[B,C]=React.useState(""),[D,E]=React.useState(!1),[F,G]=React.useState(!1),[H,I]=React.useState(!1),[J,K]=React.useState(!1),[L,M]=React.useState(!1),[N,O]=React.useState(!1),[P,Q]=React.useState(!1),[R,S]=React.useState(!1);let[T,U]=React.useState(1),[V,W]=React.useState(1);const[X,Y]=React.useState(1),[Z,$]=React.useState(1),[_,aa]=React.useState(0),[ba,ca]=React.useState(0),[da,ea]=React.useState(0),fa="true"===window.localStorage.getItem("database-font-size")?window.localStorage.getItem("font-size")??16:16,ga=[];for(let a=0;a<j.length;a++){const b=f[a]._id,c=/*#__PURE__*/React.createElement(Star,{key:b,_id:b,questionType:"tossup",initiallyStarred:starredTossupIds.has(b)});ga.push(/*#__PURE__*/React.createElement(TossupCard,{key:a,tossup:f[a],highlightedTossup:j[a],hideAnswerline:N,hideCardFooter:P,fontSize:fa,topRightComponent:c}))}const ha=[];for(let a=0;a<l.length;a++){const b=h[a]._id,c=/*#__PURE__*/React.createElement(Star,{key:b,_id:b,questionType:"bonus",initiallyStarred:starredBonusIds.has(b)});ha.push(/*#__PURE__*/React.createElement(BonusCard,{key:a,bonus:h[a],highlightedBonus:l[a],hideAnswerlines:N,hideCardFooter:P,fontSize:fa,topRightComponent:c}))}return React.useEffect(()=>{document.getElementById("report-question-submit").addEventListener("click",function(){api.reportQuestion(document.getElementById("report-question-id").value,document.getElementById("report-question-reason").value,document.getElementById("report-question-description").value)}),window.addEventListener("popstate",a=>{if(null===a.state)return o(0),g([]),k([]),q(0),i([]),m([]),Y(1),$(1),aa(0),void ca(0);const{tossups:b,highlightedTossupArray:c,bonuses:d,highlightedBonusArray:e,timeElapsed:f,workingMaxReturnLength:h,randomize:j}=a.state,{count:l,questionArray:n}=b,{count:p,questionArray:r}=d;o(l),g(n),k(c),q(p),i(r),m(e),j?(Y(1),$(1)):(Y(Math.ceil(l/h)),$(Math.ceil(p/h))),aa(paginationShiftLength*Math.floor((T-1)/paginationShiftLength)),ca(paginationShiftLength*Math.floor((V-1)/paginationShiftLength)),ea(f)}),document.getElementById("set-list").innerHTML=api.getSetList().map(a=>`<option>${a}</option>`).join("")},[]),/*#__PURE__*/React.createElement("div",null,/*#__PURE__*/React.createElement(CategoryModal,{categoryManager:categoryManager,disablePercentView:!0}),/*#__PURE__*/React.createElement("form",{className:"mt-3",onSubmit:a=>{e(a)}},/*#__PURE__*/React.createElement("div",{className:"input-group mb-2"},/*#__PURE__*/React.createElement("input",{type:"text",className:"form-control",id:"query",placeholder:"Query",value:t,onChange:a=>{u(a.target.value)}}),/*#__PURE__*/React.createElement("button",{type:"submit",className:"btn btn-info"},"Search"),/*#__PURE__*/React.createElement("button",{id:"randomize",className:"btn btn-success",onClick:a=>{e(a,!0)}},"Random")),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-6 col-xl-3 mb-2"},/*#__PURE__*/React.createElement(DifficultyDropdown,null)),/*#__PURE__*/React.createElement("div",{className:"col-6 col-xl-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"max-return-length",placeholder:"# to Display",value:r,onChange:a=>{s(a.target.value)}})),/*#__PURE__*/React.createElement("div",{className:"input-group col-12 col-xl-6 mb-2"},/*#__PURE__*/React.createElement("input",{type:"text",className:"form-control",id:"set-name",placeholder:"Set Name",list:"set-list"}),/*#__PURE__*/React.createElement("datalist",{id:"set-list"}),/*#__PURE__*/React.createElement("button",{type:"button",className:"btn btn-danger",id:"category-select-button","data-bs-toggle":"modal","data-bs-target":"#category-modal"},"Categories"))),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("select",{className:"form-select",id:"search-type",value:x,onChange:a=>{y(a.target.value)}},/*#__PURE__*/React.createElement("option",{value:"all"},"All text"),/*#__PURE__*/React.createElement("option",{value:"question"},"Question"),/*#__PURE__*/React.createElement("option",{value:"answer"},"Answer"))),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("select",{className:"form-select",id:"question-type",value:v,onChange:a=>{w(a.target.value)}},/*#__PURE__*/React.createElement("option",{value:"all"},"All questions"),/*#__PURE__*/React.createElement("option",{value:"tossup"},"Tossups"),/*#__PURE__*/React.createElement("option",{value:"bonus"},"Bonuses"))),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"min-year",placeholder:"Min Year",value:z,onChange:a=>{A(a.target.value)}})),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"max-year",placeholder:"Max Year",value:B,onChange:a=>{C(a.target.value)}}))),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-12"},/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-regex",checked:D,onChange:()=>{E(!D)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-regex"},"Search using regular expression"),/*#__PURE__*/React.createElement("a",{href:"https://www.sitepoint.com/learn-regex/"}," What's this?")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-ignore-word-order",checked:!D&&F,disabled:D,onChange:()=>{G(!F)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-ignore-word-order"},"Ignore word order")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-exact-phrase",checked:!D&&H,disabled:D,onChange:()=>{I(!H)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-exact-phrase"},"Search for exact phrase")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-case-sensitive",checked:J,onChange:()=>{K(!J)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-case-sensitive"},"Case sensitive search")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-powermark-only",checked:L,onChange:()=>{M(!L)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-powermark-only"},"Powermarked tossups only")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-hide-answerlines",checked:N,onChange:()=>{O(!N)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-hide-answerlines"},"Hide answerlines")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-hide-card-footers",checked:P,onChange:()=>{Q(!P)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-hide-card-footers"},"Hide card footers")),/*#__PURE__*/React.createElement("div",{className:"float-end"},/*#__PURE__*/React.createElement("b",null,"Download this page:"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadQuestionsAsText(f,h)}},"TXT"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadTossupsAsCSV(f),downloadBonusesAsCSV(h)}},"CSV"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadQuestionsAsJSON(f,h)}},"JSON"))))),R&&/*#__PURE__*/React.createElement("div",{className:"d-block mx-auto mt-3 spinner-border",role:"status"},/*#__PURE__*/React.createElement("span",{className:"d-none"},"Loading...")),/*#__PURE__*/React.createElement("div",{className:"row text-center mt-2 mt-sm-0"},/*#__PURE__*/React.createElement("h3",{id:"tossups"},"Tossups")),0<n?/*#__PURE__*/React.createElement("div",{className:"float-row mb-3"},/*#__PURE__*/React.createElement("span",{className:"text-muted float-start"},"Showing ",f.length," of ",n," results (",da," seconds)"),"\xA0",/*#__PURE__*/React.createElement("span",{className:"text-muted float-end"},/*#__PURE__*/React.createElement("a",{className:"clickable",onClick:()=>window.scrollTo({top:document.getElementById("bonuses").offsetTop,behavior:"smooth"})},"Jump to bonuses")))// eslint-disable-line
:/*#__PURE__*/React.createElement("div",{className:"text-muted"},"No tossups found"),/*#__PURE__*/React.createElement("div",null,ga),1<X&&/*#__PURE__*/React.createElement("nav",{"aria-label":"tossup nagivation"},/*#__PURE__*/React.createElement("ul",{className:"pagination justify-content-center"},/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"First",onClick:a=>{c(a,"first")}},"\xAB")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Previous",onClick:a=>{c(a,"previous")}},"\u2039")),a(Math.min(_),Math.min(_+paginationShiftLength,X)).map(a=>{const b=T===a+1;return/*#__PURE__*/React.createElement("li",{key:`tossup-pagination-${a+1}`,className:"page-item"},/*#__PURE__*/React.createElement("a",{className:`page-link ${b&&"active"}`,href:"#",onClick:b=>{c(b,a+1)}},a+1))}),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Next",onClick:a=>{c(a,"next")}},"\u203A")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Last",onClick:a=>{c(a,"last")}},/*#__PURE__*/React.createElement("span",{"aria-hidden":"true"},"\xBB"))))),/*#__PURE__*/React.createElement("div",{className:"mb-5"}),/*#__PURE__*/React.createElement("div",{className:"row text-center"},/*#__PURE__*/React.createElement("h3",{id:"bonuses"},"Bonuses")),0<p?/*#__PURE__*/React.createElement("div",{className:"float-row mb-3"},/*#__PURE__*/React.createElement("span",{className:"text-muted float-start"},"Showing ",h.length," of ",p," results (",da," seconds)"),"\xA0",/*#__PURE__*/React.createElement("span",{className:"text-muted float-end"},/*#__PURE__*/React.createElement("a",{className:"clickable",onClick:()=>window.scrollTo({top:document.getElementById("tossups").offsetTop,behavior:"smooth"})},"Jump to tossups")))// eslint-disable-line
:/*#__PURE__*/React.createElement("div",{className:"text-muted"},"No bonuses found"),/*#__PURE__*/React.createElement("div",null,ha),1<Z&&/*#__PURE__*/React.createElement("nav",{"aria-label":"bonus nagivation"},/*#__PURE__*/React.createElement("ul",{className:"pagination justify-content-center"},/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"First",onClick:a=>{d(a,"first")}},"\xAB")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Previous",onClick:a=>{d(a,"previous")}},"\u2039")),a(Math.min(ba),Math.min(ba+paginationShiftLength,Z)).map(a=>{const b=V===a+1;return/*#__PURE__*/React.createElement("li",{key:`bonus-pagination-${a+1}`,className:"page-item"},/*#__PURE__*/React.createElement("a",{className:`page-link ${b&&"active"}`,href:"#",onClick:b=>{d(b,a+1)}},a+1))}),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Next",onClick:a=>{d(a,"next")}},"\u203A")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Last",onClick:a=>{d(a,"last")}},/*#__PURE__*/React.createElement("span",{"aria-hidden":"true"},"\xBB"))))),/*#__PURE__*/React.createElement("div",{className:"mb-5"}))}const root=ReactDOM.createRoot(document.getElementById("root"));root.render(/*#__PURE__*/React.createElement(QueryForm,null));