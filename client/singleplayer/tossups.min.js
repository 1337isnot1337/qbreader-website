import account from"../scripts/accounts.js";import questionStats from"../scripts/auth/question-stats.js";import api from"../scripts/api/index.js";import audio from"../audio/index.js";import Timer from"../scripts/Timer.js";import{arrayToRange,createTossupCard,rangeToArray}from"../scripts/utilities/index.js";import CategoryManager from"../scripts/utilities/category-manager.js";import{attachDropdownChecklist,getDropdownValues}from"../scripts/utilities/dropdown-checklist.js";import{insertTokensIntoHTML}from"../scripts/utilities/insert-tokens-into-html.js";import CategoryModal from"../scripts/components/CategoryModal.min.js";// Functions and variables specific to the tossups page.
const ANSWER_TIME_LIMIT=10,DEAD_TIME_LIMIT=5;// Status variables
let buzzpointIndex=-1,currentlyBuzzing=!1,maxPacketNumber=24,paused=!1,questionNumber=0;// WARNING: 1-indexed
const timer=new Timer;/**
 * An array of random questions.
 * We get 20 random questions at a time so we don't have to make an HTTP request between every question.
 */let randomTossups=[],timeoutID=-1,tossups=[{}],tossupText="",tossupTextSplit=[];const previous={isCorrect:!0,inPower:!1,negValue:-5,powerValue:15,endOfQuestion:!1,celerity:0},stats=window.sessionStorage.getItem("tossup-stats")?JSON.parse(window.sessionStorage.getItem("tossup-stats")):{powers:0,tens:0,negs:0,dead:0,points:0,totalCorrectCelerity:0},defaults={alternateSubcategories:[],categories:[],difficulties:[],minYear:2010,maxYear:2024,packetNumbers:[],powermarkOnly:!1,setName:"",standardOnly:!1,subcategories:[],version:"01-06-2024"};let query;window.localStorage.getItem("singleplayer-tossup-query")?(query=JSON.parse(window.localStorage.getItem("singleplayer-tossup-query")),query.version!==defaults.version&&(query=defaults,window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query)))):query=defaults;const categoryManager=new CategoryManager(query.categories,query.subcategories,query.alternateSubcategories),settings=window.localStorage.getItem("singleplayer-tossup-settings")?JSON.parse(window.localStorage.getItem("singleplayer-tossup-settings")):{readingSpeed:50,rebuzz:!1,selectBySetName:!1,showHistory:!0,timer:!0,typeToAnswer:!0};// Load query and settings first so user doesn't see the default settings
if(settings.readingSpeed&&(document.getElementById("reading-speed-display").textContent=settings.readingSpeed,document.getElementById("reading-speed").value=settings.readingSpeed),settings.rebuzz&&(document.getElementById("toggle-rebuzz").checked=!0),settings.selectBySetName&&(document.getElementById("difficulty-settings").classList.add("d-none"),document.getElementById("set-settings").classList.remove("d-none"),document.getElementById("toggle-select-by-set-name").checked=!0,document.getElementById("toggle-powermark-only").disabled=!0,document.getElementById("toggle-standard-only").disabled=!0),settings.showHistory||(document.getElementById("toggle-show-history").checked=!1,document.getElementById("room-history").classList.add("d-none")),settings.timer||(document.getElementById("toggle-timer").checked=!1,document.getElementById("timer").classList.add("d-none")),settings.typeToAnswer||(document.getElementById("type-to-answer").checked=!1,document.getElementById("toggle-rebuzz").disabled=!0),query.difficulties)for(const a of document.getElementById("difficulties").children){const b=a.querySelector("input"),c=parseInt(b.value);query.difficulties.includes(c)&&(a.classList.add("active"),b.checked=!0)}query.packetNumbers&&(document.getElementById("packet-number").value=arrayToRange(query.packetNumbers)),query.powermarkOnly&&(document.getElementById("toggle-powermark-only").checked=!0),query.setName&&(document.getElementById("set-name").value=query.setName,api.getNumPackets(query.setName).then(a=>{maxPacketNumber=a,0===maxPacketNumber?document.getElementById("set-name").classList.add("is-invalid"):document.getElementById("packet-number").placeholder=`Packet Numbers (1-${maxPacketNumber})`})),updateStatDisplay();function queryLock(){document.getElementById("question").textContent="Fetching questions...",document.getElementById("start").disabled=!0,document.getElementById("next").disabled=!0,document.getElementById("pause").disabled=!0,document.getElementById("buzz").disabled=!0}function queryUnlock(){document.getElementById("question").textContent="",document.getElementById("start").disabled=!1,document.getElementById("next").disabled=!1,document.getElementById("pause").disabled=!1,document.getElementById("buzz").disabled=!1}/**
 * @returns {Promise<boolean>} Whether or not there is a next question
 */async function advanceQuestion(){if(settings.selectBySetName){// Get the next question if the current one is in the wrong category and subcategory
do// Go to the next packet if you reach the end of this packet
if(questionNumber++,questionNumber>tossups.length){if(query.packetNumbers.shift(),0===query.packetNumbers.length)return window.alert("No more questions left"),document.getElementById("buzz").disabled=!0,document.getElementById("pause").disabled=!0,document.getElementById("next").disabled=!0,!1;// alert the user if there are no more packets
queryLock();try{tossups=await api.getPacketTossups(query.setName,query.packetNumbers[0])}finally{queryUnlock()}questionNumber=1}while(!categoryManager.isValidCategory(tossups[questionNumber-1]));0<Object.keys(tossups[0]).length&&(tossupText=tossups[questionNumber-1].question_sanitized,tossupTextSplit=tossupText.split(" ").filter(a=>""!==a),document.getElementById("question-number-info").textContent=questionNumber)}else{queryLock();try{tossups=await getRandomTossup(query),tossups=[tossups]}finally{queryUnlock()}if(!tossups[0])return window.alert("No questions found"),!1;query.setName=tossups[0].set.name,query.packetNumbers=[tossups[0].packet.number],tossupText=tossups[0].question_sanitized,tossupTextSplit=tossupText.split(" ").filter(a=>""!==a),document.getElementById("question-number-info").textContent=tossups[0].number,questionNumber=1}return!0}/**
 * Called when the users buzzes.
 * The first "buzz" pauses the question, and the second "buzz" reveals the rest of the question
 * and updates the score.
 */function buzz(){// Stop the question reading
// Include buzzpoint
clearTimeout(timeoutID),currentlyBuzzing=!0,audio.soundEffects&&audio.buzz.play(),buzzpointIndex=document.getElementById("question").textContent.length,!tossupTextSplit.includes("(*)")&&tossupText.includes("(*)")&&(buzzpointIndex+=3),document.getElementById("question").textContent+="(#) ",document.getElementById("buzz").textContent="Reveal",document.getElementById("next").disabled=!0,document.getElementById("start").disabled=!0,document.getElementById("pause").disabled=!0,settings.timer&&(timer.stopTimer(),timer.startTimer(ANSWER_TIME_LIMIT,()=>document.getElementById("answer-submit").click()))}/**
 * Clears user stats.
 */function clearStats(){stats.powers=0,stats.tens=0,stats.negs=0,stats.dead=0,stats.points=0,stats.totalCorrectCelerity=0,updateStatDisplay(),window.sessionStorage.removeItem("tossup-stats")}async function giveAnswer(a){currentlyBuzzing=!1;const{directive:b,directedPrompt:c}=await api.checkAnswer(tossups[questionNumber-1].answer,a);switch(b){case"accept":{const a=updateScore(!0);audio.soundEffects&&(10<a?audio.power.play():audio.correct.play()),revealQuestion();break}case"reject":updateScore(!1),audio.soundEffects&&audio.incorrect.play(),settings.rebuzz?(document.getElementById("buzz").disabled=!1,document.getElementById("buzz").textContent="Buzz",document.getElementById("next").disabled=!1,document.getElementById("pause").disabled=!1,document.getElementById("start").disabled=!1,readQuestion(Date.now())):revealQuestion();break;case"prompt":document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),document.getElementById("answer-input").placeholder=c?`Prompt: "${c}"`:"Prompt"}}function isPace(a){return!!a&&a.includes("PACE")}async function loadRandomTossups({alternateSubcategories:a,categories:b,difficulties:c,maxYear:d,minYear:e,number:i=1,powermarkOnly:f,standardOnly:g,subcategories:h}={}){randomTossups=[],randomTossups=await api.getRandomTossup({alternateSubcategories:a,categories:b,difficulties:c,maxYear:d,minYear:e,number:i,powermarkOnly:f,standardOnly:g,subcategories:h})}/**
 * Get a random tossup.
 * @returns
 */async function getRandomTossup({alternateSubcategories:a,categories:b,difficulties:c,minYear:d,maxYear:e,powermarkOnly:f,subcategories:g,standardOnly:h}={}){0===randomTossups.length&&(await loadRandomTossups({alternateSubcategories:a,categories:b,difficulties:c,maxYear:e,minYear:d,number:20,powermarkOnly:f,subcategories:g,standardOnly:h}));const i=randomTossups.pop();// Begin loading the next batch of questions (asynchronously)
return 0===randomTossups.length&&loadRandomTossups({alternateSubcategories:a,categories:b,difficulties:c,maxYear:e,minYear:d,number:20,powermarkOnly:f,subcategories:g,standardOnly:h}),i}async function next(){if(clearTimeout(timeoutID),currentlyBuzzing=!1,settings.timer&&(timer.stopTimer(),timer.tenthsRemaining=0,timer.updateDisplay()),(await account.getUsername())&&document.getElementById("answer").innerHTML){const a=previous.isCorrect?previous.inPower?previous.powerValue:10:previous.endOfQuestion?0:previous.negValue;questionStats.recordTossup(tossups[questionNumber-1],previous.isCorrect,a,previous.celerity,!1)}document.getElementById("answer").textContent="",document.getElementById("question").textContent="",document.getElementById("toggle-correct").textContent="I was wrong",document.getElementById("toggle-correct").classList.add("d-none");const a=await advanceQuestion();a&&(document.getElementById("buzz").textContent="Buzz",document.getElementById("buzz").disabled=!1,document.getElementById("next").textContent="Skip",document.getElementById("packet-number-info").textContent=query.packetNumbers[0],document.getElementById("packet-length-info").textContent=settings.selectBySetName?tossups.length:"-",document.getElementById("pause").textContent="Pause",document.getElementById("pause").disabled=!1,document.getElementById("question").textContent="",document.getElementById("set-name-info").textContent=query.setName,paused=!1,readQuestion(Date.now()))}/**
 * Toggles pausing or resuming the tossup.
 */function pause(){paused?(document.getElementById("buzz").removeAttribute("disabled"),document.getElementById("pause").textContent="Pause",readQuestion(Date.now())):(document.getElementById("buzz").setAttribute("disabled","disabled"),document.getElementById("pause").textContent="Resume",clearTimeout(timeoutID)),paused=!paused}/**
 * Recursively reads the question based on the reading speed.
 */function readQuestion(a){if(!currentlyBuzzing&&0<tossupTextSplit.length){const b=tossupTextSplit.shift();"(*)"!==b&&(document.getElementById("question").textContent+=b+" ");// calculate time needed before reading next word
let c=Math.log(b.length)+1;b.endsWith(".")&&96<b.charCodeAt(b.length-2)&&123>b.charCodeAt(b.length-2)||".\u201D"===b.slice(-2)||"!\u201D"===b.slice(-2)||"?\u201D"===b.slice(-2)?c+=2:b.endsWith(",")||",\u201D"===b.slice(-2)?c+=.75:"(*)"===b&&(c=0),c=.9*c*(125-settings.readingSpeed);const d=c-Date.now()+a;timeoutID=window.setTimeout(()=>{readQuestion(c+a)},d)}else document.getElementById("pause").disabled=!0,settings.timer&&timer.startTimer(DEAD_TIME_LIMIT,revealQuestion)}function revealQuestion(){document.getElementById("question").innerHTML=insertTokensIntoHTML(tossups[questionNumber-1].question,tossups[questionNumber-1].question_sanitized,[[buzzpointIndex]],[" (#) "]),document.getElementById("answer").innerHTML="ANSWER: "+tossups[questionNumber-1].answer,document.getElementById("buzz").disabled=!0,document.getElementById("buzz").textContent="Buzz",document.getElementById("next").disabled=!1,document.getElementById("next").textContent="Next",document.getElementById("start").disabled=!1,document.getElementById("toggle-correct").classList.remove("d-none"),document.getElementById("toggle-correct").textContent=previous.isCorrect?"I was wrong":"I was right"}function toggleCorrect(){const a=previous.isCorrect?-1:1;previous.inPower?(stats.powers+=1*a,stats.points+=a*previous.powerValue):(stats.tens+=1*a,stats.points+=10*a),previous.endOfQuestion?stats.dead+=-1*a:(stats.negs+=-1*a,stats.points+=a*-previous.negValue),stats.totalCorrectCelerity+=a*previous.celerity,previous.isCorrect=!previous.isCorrect,document.getElementById("toggle-correct").textContent=previous.isCorrect?"I was wrong":"I was right",updateStatDisplay(),window.sessionStorage.setItem("tossup-stats",JSON.stringify(stats))}function updateScore(a){const b=0===tossupTextSplit.length,c=tossupTextSplit.includes("(*)")&&tossupText.includes("(*)"),d=isPace(query.setName)?20:15,e=isPace(query.setName)?0:-5,f=a?c?d:10:b?0:e,g=tossupTextSplit.join(" ").length,h=g/tossupText.length;let i;return a?(i=c?"powers":"tens",stats.totalCorrectCelerity+=h):i=b?"dead":"negs",stats[i]+=1,stats.points+=f,previous.celerity=h,previous.endOfQuestion=b,previous.inPower=c,previous.negValue=e,previous.powerValue=d,previous.isCorrect=a,updateStatDisplay(),window.sessionStorage.setItem("tossup-stats",JSON.stringify(stats)),f}/**
 * Updates the displayed stat line.
 */function updateStatDisplay(){const{powers:a,tens:b,negs:c,dead:d,points:e,totalCorrectCelerity:f}=stats,g=a+b+c+d,h=a+b;let i=0===h?0:parseFloat(f)/h;i=Math.round(1e3*i)/1e3;const j=1===g?"":"s";// disable clear stats button if no stats
document.getElementById("statline").innerHTML=`${a}/${b}/${c} with ${g} tossup${j} seen (${e} pts, celerity: ${i})`,document.getElementById("clear-stats").disabled=0===g}document.getElementById("answer-form").addEventListener("submit",function(a){a.preventDefault(),a.stopPropagation(),settings.timer&&(timer.stopTimer(),timer.tenthsRemaining=0,timer.updateDisplay());const b=document.getElementById("answer-input").value;document.getElementById("answer-input").value="",document.getElementById("answer-input").blur(),document.getElementById("answer-input").placeholder="Enter answer",document.getElementById("answer-input-group").classList.add("d-none"),giveAnswer(b)}),document.getElementById("buzz").addEventListener("click",function(){// reveal answer on second click
// when NOT using type to answer
return this.blur(),currentlyBuzzing?(currentlyBuzzing=!1,updateScore(!0),void revealQuestion()):void(buzz(),settings.typeToAnswer&&(document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),this.disabled=!0))}),document.getElementById("clear-stats").addEventListener("click",function(){this.blur(),clearStats()}),document.getElementById("difficulties").addEventListener("change",function(){query.difficulties=getDropdownValues("difficulties"),loadRandomTossups(query),window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query))}),document.getElementById("next").addEventListener("click",function(){this.blur(),createTossupCard(tossups[questionNumber-1]),next()}),document.getElementById("packet-number").addEventListener("change",function(){// if field is blank, store blank result in `query`
query.packetNumbers=rangeToArray(this.value.trim(),0),window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query)),query.packetNumbers=rangeToArray(this.value.trim(),maxPacketNumber)}),document.getElementById("pause").addEventListener("click",function(){this.blur(),pause()}),document.getElementById("reading-speed").addEventListener("input",function(){settings.readingSpeed=this.value,document.getElementById("reading-speed-display").textContent=this.value,window.localStorage.setItem("singleplayer-tossup-settings",JSON.stringify(settings))}),document.getElementById("report-question-submit").addEventListener("click",function(){api.reportQuestion(document.getElementById("report-question-id").value,document.getElementById("report-question-reason").value,document.getElementById("report-question-description").value)}),document.getElementById("set-name").addEventListener("change",async function(){query.setName=this.value.trim(),api.getSetList().includes(this.value)||0===this.value.length?this.classList.remove("is-invalid"):this.classList.add("is-invalid"),maxPacketNumber=await api.getNumPackets(this.value),document.getElementById("packet-number").placeholder=""===this.value||0===maxPacketNumber?"Packet Numbers":`Packet Numbers (1-${maxPacketNumber})`,window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query))}),document.getElementById("start").addEventListener("click",async function(){if(this.blur(),0===query.setName.length&&settings.selectBySetName)return window.alert("Please enter a set name."),!1;if(0===query.packetNumbers.length&&settings.selectBySetName&&(query.packetNumbers=rangeToArray(document.getElementById("packet-number").value.trim(),maxPacketNumber)),document.getElementById("next").disabled=!1,document.getElementById("next").textContent="Skip",document.getElementById("options").classList.add("d-none"),document.getElementById("toggle-options").disabled=!1,settings.selectBySetName){queryLock(),questionNumber=0;try{tossups=await api.getPacketTossups(query.setName,query.packetNumbers[0])}finally{queryUnlock()}}next()}),document.getElementById("toggle-correct").addEventListener("click",function(){this.blur(),toggleCorrect()}),document.getElementById("toggle-powermark-only").addEventListener("click",function(){this.blur(),query.powermarkOnly=this.checked,loadRandomTossups(query),window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query))}),document.getElementById("toggle-select-by-set-name").addEventListener("click",function(){this.blur(),settings.selectBySetName=this.checked,document.getElementById("toggle-powermark-only").disabled=this.checked,document.getElementById("toggle-standard-only").disabled=this.checked,this.checked?(document.getElementById("difficulty-settings").classList.add("d-none"),document.getElementById("set-settings").classList.remove("d-none")):(document.getElementById("difficulty-settings").classList.remove("d-none"),document.getElementById("set-settings").classList.add("d-none")),window.localStorage.setItem("singleplayer-tossup-settings",JSON.stringify(settings))}),document.getElementById("toggle-show-history").addEventListener("click",function(){this.blur(),settings.showHistory=this.checked,this.checked?document.getElementById("room-history").classList.remove("d-none"):document.getElementById("room-history").classList.add("d-none"),window.localStorage.setItem("singleplayer-tossup-settings",JSON.stringify(settings))}),document.getElementById("toggle-standard-only").addEventListener("click",function(){this.blur(),query.standardOnly=this.checked,loadRandomTossups(query),window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query))}),document.getElementById("toggle-timer").addEventListener("click",function(){this.blur(),settings.timer=this.checked,document.getElementById("timer").classList.toggle("d-none"),window.localStorage.setItem("singleplayer-tossup-settings",JSON.stringify(settings))}),document.getElementById("type-to-answer").addEventListener("click",function(){this.blur(),settings.typeToAnswer=this.checked,document.getElementById("toggle-rebuzz").disabled=!this.checked,window.localStorage.setItem("singleplayer-tossup-settings",JSON.stringify(settings))}),document.getElementById("toggle-rebuzz").addEventListener("click",function(){this.blur(),settings.rebuzz=this.checked,window.localStorage.setItem("singleplayer-tossup-settings",JSON.stringify(settings))}),document.getElementById("year-range-a").onchange=function(){query.minYear=$("#slider").slider("values",0),query.maxYear=$("#slider").slider("values",1),loadRandomTossups(query),window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query))},document.getElementById("year-range-b").onchange=function(){query.minYear=$("#slider").slider("values",0),query.maxYear=$("#slider").slider("values",1),loadRandomTossups(query),window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query))},document.addEventListener("keydown",a=>{if(!["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName))switch(a.key){case" ":document.getElementById("buzz").click(),a.target===document.body&&a.preventDefault();break;case"k":document.getElementsByClassName("card-header-clickable")[0].click();break;case"t":document.getElementsByClassName("star-tossup")[0].click();break;case"y":navigator.clipboard.writeText(tossups[0]?._id??"");break;case"n":document.getElementById("next").click();break;case"p":document.getElementById("pause").click();break;case"s":document.getElementById("start").click()}}),attachDropdownChecklist(),$("#slider").slider("values",0,query.minYear),$("#slider").slider("values",1,query.maxYear),document.getElementById("year-range-a").textContent=query.minYear,document.getElementById("year-range-b").textContent=query.maxYear;const root=ReactDOM.createRoot(document.getElementById("category-modal-root"));root.render(/*#__PURE__*/React.createElement(CategoryModal,{categoryManager:categoryManager,onClose:()=>{({categories:query.categories,subcategories:query.subcategories,alternateSubcategories:query.alternateSubcategories}=categoryManager.export()),loadRandomTossups(query),window.localStorage.setItem("singleplayer-tossup-query",JSON.stringify(query))}}));